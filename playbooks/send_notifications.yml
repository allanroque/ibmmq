---
- name: "Notifica√ß√µes de Conclus√£o - Etapa 10"
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/vars.yml
  
  tasks:
    - name: "Coletar resultados de todos os hosts"
      set_fact:
        all_results: "{{ hostvars | dict2items | selectattr('value.mq_health', 'defined') | map(attribute='value') | list }}"

    - name: "Determinar status geral da atualiza√ß√£o"
      set_fact:
        overall_status: "{{ 'SUCCESS' if all_results | selectattr('update_result.status', 'equalto', 'success') | list | length == all_results | length else 'FAILED' }}"

    - name: "Criar relat√≥rio consolidado"
      copy:
        content: |
          # RELAT√ìRIO CONSOLIDADO DE ATUALIZA√á√ÉO IBM MQ
          Data: {{ ansible_date_time.iso8601 }}
          Vers√£o Update: {{ updatemq_version }}
          Status Geral: {{ overall_status }}
          
          ## RESUMO POR HOST:
          {% for host in all_results %}
          ### Host: {{ host.inventory_hostname }}
          - IP: {{ host.ansible_host }}
          - Vers√£o Anterior: {{ host.mq_health.version.Version | default('N/A') }}
          - QMs Rodando: {{ host.mq_health.qmgrs_running | length if host.mq_health.qmgrs_running is defined else 0 }}
          - Status da Atualiza√ß√£o: {{ host.update_result.status | default('N/A') if host.update_result is defined else 'N/A' }}
          - Vers√£o Nova: {{ host.update_result.new_version | default('N/A') if host.update_result is defined else 'N/A' }}
          - QMs Ativos P√≥s-Atualiza√ß√£o: {{ host.update_result.qms_running | default('N/A') if host.update_result is defined else 'N/A' }}
          - Valida√ß√£o P√≥s-Atualiza√ß√£o: {{ host.post_validation_result.status | default('N/A') if host.post_validation_result is defined else 'N/A' }}
          - Testes Funcionais: {{ host.functional_tests_result.status | default('N/A') if host.functional_tests_result is defined else 'N/A' }}
          {% if host.functional_tests_result is defined %}
          - Testes Executados: {{ host.functional_tests_result.total_tests | default('N/A') }}
          - Sucessos: {{ host.functional_tests_result.successful_tests | default('N/A') }}
          - Falhas: {{ host.functional_tests_result.failed_tests | default('N/A') }}
          {% endif %}
          
          {% endfor %}
          
          ## ESTAT√çSTICAS GERAIS:
          - Total de Hosts: {{ all_results | length }}
          - Atualiza√ß√µes Bem-sucedidas: {{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}
          - Atualiza√ß√µes com Falha: {{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}
          - Hosts com Valida√ß√£o OK: {{ all_results | selectattr('post_validation_result.status', 'equalto', 'success') | list | length }}
          - Hosts com Testes OK: {{ all_results | selectattr('functional_tests_result.status', 'equalto', 'success') | list | length }}
          
          ## PR√ìXIMOS PASSOS:
          {% if overall_status == 'SUCCESS' %}
          - ‚úÖ Atualiza√ß√£o conclu√≠da com sucesso
          - ‚úÖ Todos os hosts est√£o funcionando
          - ‚úÖ Valida√ß√µes aprovadas
          - ‚úÖ Testes funcionais passaram
          - üìã Monitorar logs por 24h
          - üìã Verificar performance
          {% else %}
          - ‚ùå Atualiza√ß√£o com falhas detectadas
          - üîç Revisar logs de erro
          - üîç Verificar hosts com falha
          - üîÑ Considerar rollback se necess√°rio
          - üìû Contatar equipe de suporte
          {% endif %}
        dest: "/tmp/mq_update_consolidated_report_{{ updatemq_version }}_{{ ansible_date_time.iso8601_basic }}.txt"
        mode: '0644'

    - name: "Enviar notifica√ß√£o por email (se configurado)"
      mail:
        to: "{{ notification_email | default('admin@company.com') }}"
        subject: "IBM MQ Update {{ updatemq_version }} - {{ overall_status }}"
        body: |
          Atualiza√ß√£o do IBM MQ conclu√≠da.
          
          Status: {{ overall_status }}
          Hosts: {{ all_results | length }}
          Sucessos: {{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}
          Falhas: {{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}
          
          Relat√≥rio completo em: /tmp/mq_update_consolidated_report_{{ updatemq_version }}_{{ ansible_date_time.iso8601_basic }}.txt
        smtp_server: "{{ smtp_server | default('localhost') }}"
        smtp_port: "{{ smtp_port | default(25) }}"
      when: notification_email is defined
      ignore_errors: true

    - name: "Enviar notifica√ß√£o para Slack (se configurado)"
      uri:
        url: "{{ slack_webhook_url | default('') }}"
        method: POST
        body_format: json
        body:
          text: |
            üöÄ *IBM MQ Update {{ updatemq_version }} - {{ overall_status }}*
            
            üìä *Resumo:*
            ‚Ä¢ Hosts: {{ all_results | length }}
            ‚Ä¢ Sucessos: {{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}
            ‚Ä¢ Falhas: {{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}
            
            {% if overall_status == 'SUCCESS' %}
            ‚úÖ Atualiza√ß√£o conclu√≠da com sucesso!
            {% else %}
            ‚ùå Atualiza√ß√£o com falhas - verificar logs
            {% endif %}
            
            Data: {{ ansible_date_time.iso8601 }}
        status_code: 200
      when: slack_webhook_url is defined
      ignore_errors: true

    - name: "Criar ticket de acompanhamento (se configurado)"
      uri:
        url: "{{ ticketing_system_url | default('') }}"
        method: POST
        headers:
          Authorization: "Bearer {{ ticketing_system_token | default('') }}"
        body_format: json
        body:
          title: "IBM MQ Update {{ updatemq_version }} - {{ overall_status }}"
          description: |
            Atualiza√ß√£o do IBM MQ vers√£o {{ updatemq_version }}.
            
            Status: {{ overall_status }}
            Hosts processados: {{ all_results | length }}
            Sucessos: {{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}
            Falhas: {{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}
            
            Relat√≥rio: /tmp/mq_update_consolidated_report_{{ updatemq_version }}_{{ ansible_date_time.iso8601_basic }}.txt
          priority: "{{ 'high' if overall_status == 'FAILED' else 'medium' }}"
          status: "{{ 'open' if overall_status == 'FAILED' else 'closed' }}"
        status_code: 200
      when: ticketing_system_url is defined and ticketing_system_token is defined
      ignore_errors: true

    - name: "Registrar no log do AAP Controller"
      ansible.controller.job_template:
        name: "MQ Update Log - {{ updatemq_version }}"
        job_type: "run"
        inventory: "{{ ac_inv_all_hosts }}"
        playbook: "log_update_result.yml"
        extra_vars:
          update_version: "{{ updatemq_version }}"
          overall_status: "{{ overall_status }}"
          results: "{{ all_results }}"
      when: ac_inv_all_hosts is defined
      ignore_errors: true

    - name: "Mostrar resumo final"
      debug:
        msg: |
          ========================================
          RELAT√ìRIO FINAL DE ATUALIZA√á√ÉO IBM MQ
          ========================================
          Data: {{ ansible_date_time.iso8601 }}
          Vers√£o: {{ updatemq_version }}
          Status Geral: {{ overall_status }}
          
          Hosts Processados: {{ all_results | length }}
          Sucessos: {{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}
          Falhas: {{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}
          
          {% if overall_status == 'SUCCESS' %}
          ‚úÖ ATUALIZA√á√ÉO CONCLU√çDA COM SUCESSO!
          {% else %}
          ‚ùå ATUALIZA√á√ÉO COM FALHAS - VERIFICAR LOGS
          {% endif %}
          
          Relat√≥rio completo: /tmp/mq_update_consolidated_report_{{ updatemq_version }}_{{ ansible_date_time.iso8601_basic }}.txt

    - name: "Registrar resultado final"
      set_fact:
        final_update_result:
          overall_status: "{{ overall_status }}"
          total_hosts: "{{ all_results | length }}"
          successful_updates: "{{ all_results | selectattr('update_result.status', 'equalto', 'success') | list | length }}"
          failed_updates: "{{ all_results | selectattr('update_result.status', 'defined') | selectattr('update_result.status', 'notequalto', 'success') | list | length }}"
          report_file: "/tmp/mq_update_consolidated_report_{{ updatemq_version }}_{{ ansible_date_time.iso8601_basic }}.txt"
          timestamp: "{{ ansible_date_time.iso8601 }}"
