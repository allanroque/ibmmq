---
- name: Preparar ambiente base para IBM MQ (usuário, diretórios e pacotes)
  hosts: "{{ managed_node | default('none') }}"
  become: true

  vars:
    mq_user: mqm
    mq_group: mqm
    mq_home: /home/mqm
    mq_base_dir: /opt/mqm
    mq_install_dir: "{{ mq_home }}/IBM_MQ"

  tasks:

    - name: Dependências básicas
      ansible.builtin.dnf:
        name:
          - gcc
          - gcc-c++
          - make
          - pam
          - libstdc++
          - glibc
          - acl
        state: present

    - name: Criar grupo e usuário MQ
      ansible.builtin.user:
        name: "{{ mq_user }}"
        group: "{{ mq_group }}"
        create_home: true
        home: "{{ mq_home }}"
        shell: /bin/bash
        state: present

    - name: Criar diretórios base e de instalação
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ mq_user }}"
        group: "{{ mq_group }}"
        mode: '0755'
      loop:
        - "{{ mq_base_dir }}"
        - "{{ mq_install_dir }}"

    - name: Criar diretório de trabalho
      ansible.builtin.file:
        path: "{{ mq_install_dir }}/download"
        state: directory
        owner: "{{ mq_user }}"
        group: "{{ mq_group }}"
        mode: '0755'

    - name: Exibir resultado final da preparação
      ansible.builtin.debug:
        msg:
          - "Dependências básicas instaladas"
          - "Grupo {{ mq_group }} criado"
          - "Usuário {{ mq_user }} criado em {{ mq_home }}"
          - "Diretórios preparados:"
          - "  - {{ mq_base_dir }}"
          - "  - {{ mq_install_dir }}"
          - "  - {{ mq_install_dir }}/download"
